!function(e){if(!window.Craft||!window.jQuery||"undefined"===Craft)return!1;Craft.Relabel=Garnish.Base.extend({elementEditors:{},labelsForLayout:[],fields:null,labels:null,layouts:null,hud:null,currentFieldId:null,values:{},container:"",closeHud:function(){this.hud.hide(),this.hud.destroy(),delete this.hud},init:function(t){var i=this;this.labels=t.labels,this.labelsForLayout=t.labelsForLayout;var n=this.getFieldsForLayout();e.each(n,function(e,t){i.values[t.fieldId]={name:t.name,instructions:t.instructions},i.getHiddenInput(t.fieldId,"name",t.name),i.getHiddenInput(t.fieldId,"instructions",t.instructions),i.toggleLineSpan(t.fieldId,i.values[t.fieldId].name)}),this.setup(),this.labelsForLayout.length&&this.applyLabels(this.labelsForLayout,!0)},changeEntryType:function(e){var t=this;setTimeout(function(){t.applyLabels(e,!0)},20)},initElementEditor:function(t,i){var n=this,a=(new Date).getTime(),l=function(){var i=(new Date).getTime(),s=e(".elementeditor:last"),d=s.length>0&&s.closest(".hud"),r=!!(d&&d.length>0)&&d.data("elementEditor");r&&r.hud?(this.elementEditors[r._namespace]=r,r.hud.on("hide",e.proxy(this.destroyElementEditor,this,r)),setTimeout(function(){n.applyLabels(t,!1)},20)):i-a<2e3&&Garnish.requestAnimationFrame(l)}.bind(this);l()},destroyElementEditor:function(e){this.elementEditors.hasOwnProperty(e._namespace)&&delete this.elementEditors[e._namespace]},applyLabels:function(t,i){var n,a,l,s,d=this;if(this.elementEditors&&Object.keys(this.elementEditors).length)for(var r in this.elementEditors)a=this.elementEditors[r].$form;if(!(n=void 0===a?e("#main"):a)||!n.length)return!1;n.find(".field").not(".matrixblock .field").each(function(){if(l=e(this),s=d.getFieldHandleFromAttribute(l.attr("id"))){var n=l.find(".heading:first label"),a=d.getLabelForField(s,t);!1!==a&&(n.contents()[0].data=a+" ");var r=d.getInstructionForField(s,t);if(!1!==r&&i){var o=l.find(".heading:first .instructions");o.length||(l.find(".heading:first").append('<div class="instructions"></div>'),o=l.find(".heading:first .instructions")),o.html(r)}}l.attr("data-relabel",!0)})},getLabelForField:function(t,i){var n=!1;return e.each(i,function(e,i){if(i.handle===t)return n=i.name,i.name}),n},getInstructionForField:function(t,i){var n=!1;return e.each(i,function(e,i){if(i.handle===t)return n=i.instructions,i.instructions}),n},getFieldHandleFromAttribute:function(e){return!!e&&(!((e=e.split("-")).length<3)&&e[e.length-2])},onKeyDown:function(t){t.preventDefault();var i=e(t.target);if(i.data("menubtn")){var n=i.data("menubtn").menu.$menuList;this.currentFieldId=i.parent().data("id"),0===n.find(".relabel").length&&n.append('<li><a data-id="'+this.currentFieldId+'" class="relabel" data-action="showRelabelMenu">Relabel</a></li>')}},setup:function(){var t=this;Craft.FieldLayoutDesigner.prototype.initField=function(i){var n=i.find(".settings"),a=e('<div class="menu" data-align="center"/>').insertAfter(n),l=e("<ul/>").appendTo(a),s=n.parent().data("id");i.hasClass("fld-required")?e('<li><a data-action="toggle-required">'+Craft.t("app","Make not required")+"</a></li>").appendTo(l):e('<li><a data-action="toggle-required">'+Craft.t("app","Make required")+"</a></li>").appendTo(l),e('<li><a data-action="remove">'+Craft.t("app","Remove")+"</a></li>").appendTo(l),e('<li><a data-id="'+s+'" class="relabel" data-action="showRelabelMenu">Relabel</a></li>').appendTo(l),new Garnish.MenuBtn(n,{onOptionSelect:e.proxy(this,"onFieldOptionSelect")}).on("optionSelect",function(i){var n=e(i.option),a=n.data("menu").$anchor.parent(),l=n.data("action"),s=e(a).data("id");"showRelabelMenu"===l&&t.showHoverMenu(a,s)})};var i=e("#fieldlayoutform").find(".icon.settings");e.each(i,function(i,n){(n=e(n)).data("menubtn")&&n.on("click",function(i){var a=n.parent().data("id"),l=n.data("menubtn").menu.$menuList;l.find('.relabel[data-action="showRelabelMenu"]').length||e('<li><a data-id="'+a+'" class="relabel" data-action="showRelabelMenu">Relabel</a></li>').appendTo(l).on("click",function(){t.showHoverMenu(e(this),a)})})})},showHoverMenu:function(t,i){var n=this;this.currentFieldId=i;var a,l,s=e(t),d=e("<div/>");a=e('<div class="field"><div class="heading"><label for="relabel-name">'+Craft.t("relabel","new label")+"</label></div></div>").appendTo(d),l=e('<div class="input"/>').appendTo(a);var r="";i in this.values&&(r=this.values[i].name),e('<input type="text" class="text fullwidth" name="relabel-name" id="relabel-name"/>').appendTo(l).val(r),a=e('<div class="field"><div class="heading"><label for="relabel-instructions">'+Craft.t("relabel","new description")+"</label></div></div>").appendTo(d),l=e('<div class="input"/>').appendTo(a),r="",i in this.values&&(r=this.values[i].instructions),e('<textarea type="" class="text fullwidth" name="relabel-name" id="relabel-instructions"/></textarea>').appendTo(l).val(r);var o=e('<div class="hud-footer"/>').appendTo(d),u=e('<div class="buttons right"/>').appendTo(o);this.$saveBtn=e('<input type="submit" class="btn submit" value="'+Craft.t("app","Save")+'"/>').appendTo(u),this.$closeBtn=e('<button type="button" class="btn" >'+Craft.t("app","Abbrechen")+"</button>").appendTo(u),this.$spinner=e('<div class="spinner hidden"/>').appendTo(u),this.$closeBtn.on("click",function(){n.closeHud()}),this.hud=new Garnish.HUD(s,d,{onSubmit:e.proxy(this,"saveRelabel")})},saveRelabel:function(){var e=this.getHiddenInput(this.currentFieldId,"name"),t=this.getHiddenInput(this.currentFieldId,"instructions"),i=this.hud.$body.find("#relabel-name").val(),n=this.hud.$body.find("#relabel-instructions").val();this.values[this.currentFieldId]={name:i,instructions:n},e.val(i),t.val(n),this.toggleLineSpan(this.currentFieldId,i),this.closeHud()},toggleLineSpan:function(t,i){var n=e('.fld-field[data-id="'+t+'"]');void 0===i&&!1 in(i=this.values[t])&&(i=null),i?(n.first().children().eq(1).css("text-decoration","line-through"),n.first().addClass("layout-tooltip").append('<span class="tooltiptext">'+i+"</span>")):(n.first().children().eq(1).css("text-decoration",""),n.first().removeClass("layout-tooltip"),n.find(".tooltiptext").remove())},getHiddenInput:function(t,i,n){var a="relabel-field-input-"+i+"-"+t,l=e("#"+a);return void 0===n&&(n=this.hud.$body.find("#relabel-"+i).val()),0===l.length&&(l=e('<input value="'+n+'" type="hidden" id="'+a+'" name="relabel['+t+"]["+i+']">').appendTo(Craft.cp.$primaryForm)),l},getFieldLayoutId:function(){return e("#fieldlayoutform").find("[name=fieldLayoutId]").val()},getFieldsForLayout:function(e){return void 0===e&&(e=this.getFieldLayoutId()),void 0!==e&&(this.fields=this.labels.filter(function(t){return parseInt(t.fieldLayoutId)===parseInt(e)})),this.fields},getFieldContextSelector:function(){return this.isLivePreview?".lp-editor":"#main"}})}(window.jQuery);